<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Market Maker: Liquidity Hunter</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    body { margin: 0; background: #0b0e11; color: #c9d1d9; font-family: 'Roboto Mono', monospace; overflow-y: auto; -webkit-tap-highlight-color: transparent; }
    .wrapper { max-width: 600px; margin: 0 auto; padding: 10px; }
    
    /* HUD */
    .header { text-align: center; margin-bottom: 15px; }
    h3 { margin: 5px 0; color: #f0f6fc; text-transform: uppercase; letter-spacing: 1px; }
    .status-text { font-size: 11px; color: #8b949e; height: 15px;}

    .stats-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;
    }
    .stat-card {
        background: #161b22; padding: 10px; border: 1px solid #30363d; border-radius: 6px;
        display: flex; flex-direction: column; justify-content: space-between;
    }
    .stat-label { font-size: 10px; color: #8b949e; text-transform: uppercase; }
    .stat-val { font-size: 16px; font-weight: 700; color: #f0f6fc; }
    .usd { color: #3fb950; }
    .btc { color: #f0f6fc; }

    /* SUPPLY BAR */
    .supply-container {
        background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-bottom: 10px;
    }
    .supply-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; }
    .bar-bg { width: 100%; height: 12px; background: #21262d; border-radius: 6px; overflow: hidden; position: relative; }
    .bar-fill { height: 100%; background: linear-gradient(90deg, #d29922, #db6d28); width: 85%; transition: width 0.3s; }
    .bar-marker { position: absolute; left: 30%; top:0; bottom:0; width: 2px; background: #3fb950; opacity: 0.5; }
    
    /* CHARTS */
    .chart-box { border: 1px solid #30363d; background: #0d1117; height: 280px; margin-bottom: 15px; border-radius: 6px; overflow: hidden; }
    #chart { width: 100%; height: 100%; }

    /* CONTROLS */
    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    button {
        padding: 15px 5px; border: none; border-radius: 6px; font-weight: 700; font-family: inherit; font-size: 13px;
        cursor: pointer; color: #fff; transition: all 0.1s; display: flex; flex-direction: column; align-items: center;
        border-bottom: 3px solid rgba(0,0,0,0.3);
    }
    button:active { transform: translateY(2px); border-bottom: 1px solid rgba(0,0,0,0.3); }
    .btn-sub { font-size: 9px; font-weight: 400; opacity: 0.8; margin-top: 2px; }

    .btn-dump { background: #da3633; color: #fff; } /* Red */
    .btn-pump { background: #238636; color: #fff; } /* Green */
    .btn-trap { background: #d29922; color: #1f1f1f; } /* Yellow/Orange */

    /* LOGS */
    #log { font-size: 10px; color: #8b949e; text-align: center; margin-top: 10px; height: 20px; }
</style>
</head>
<body>

<div class="wrapper">
    <div class="header">
        <h3>Liquidity Hunter</h3>
        <div class="status-text">PHASE: <span id="phase-display">ANALYSIS</span></div>
    </div>

    <div class="supply-container">
        <div class="supply-header">
            <span class="stat-label">Floating Supply (Weak Hands)</span>
            <span class="stat-val" id="ui-supply">85%</span>
        </div>
        <div class="bar-bg">
            <div class="bar-marker" title="Safe Zone"></div>
            <div class="bar-fill" id="supply-bar"></div>
        </div>
        <div class="stat-label" style="margin-top:4px; font-size: 9px; color: #8b949e;">
            * High Supply = Hard to Pump. Shake them out!
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">LIQUIDITY (USDT)</span>
            <span class="stat-val usd" id="ui-usd">$1,000,000</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">INVENTORY (BTC)</span>
            <span class="stat-val btc" id="ui-btc">50.00</span>
        </div>
    </div>

    <div class="chart-box"><div id="chart"></div></div>

    <div class="controls">
        <button class="btn-dump" onclick="actionDump()">
            DUMP
            <span class="btn-sub">SHAKEOUT</span>
        </button>
        <button class="btn-trap" onclick="actionTrap()">
            BULL TRAP
            <span class="btn-sub">LURE BUYERS</span>
        </button>
        <button class="btn-pump" onclick="actionPump()">
            PUMP
            <span class="btn-sub">MARK UP</span>
        </button>
    </div>
    <div id="log">Market is quiet...</div>
</div>

<script>
// --- CONFIGURATION ---
const TIMEFRAME_SEC = 60; 
let balanceUSD = 1000000;
let balanceBTC = 50;
let price = 1000;

// GAME STATE
let floatingSupply = 0.85; // 85% монет в слабых руках. Главный враг.
let crowdFOMO = 0;         // Жадность толпы (0-100)
let isTrapActive = false;

// CHART SETUP
const chart = LightweightCharts.createChart(document.getElementById('chart'), {
    layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
    grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
    timeScale: { timeVisible: true, secondsVisible: true, rightOffset: 5 },
    rightPriceScale: { borderVisible: false },
});
const candleSeries = chart.addCandlestickSeries({
    upColor: '#238636', downColor: '#da3633', borderVisible: false, wickUpColor: '#238636', wickDownColor: '#da3633'
});

let currentBar = { time: Math.floor(Date.now()/1000), open: price, high: price, low: price, close: price };
candleSeries.update(currentBar);

// --- CORE MECHANICS ---

// 1. DYNAMIC RESISTANCE (Главная формула)
function getResistances() {
    // Чем больше Floating Supply, тем тяжелее пампить (Up Resistance выше)
    // Supply 85% -> Up Res ~ 1000 (Очень тяжело)
    // Supply 10% -> Up Res ~ 50 (Летит само)
    const upRes = 50 + (floatingSupply * 2000); 
    
    // Вниз падать легко, если Supply высокий (паник селл)
    // Но если Supply низкий (мы всех вытряхнули), вниз продавить сложнее (дефицит)
    const downRes = 200 + ((1 - floatingSupply) * 1000); 
    
    return { up: upRes, down: downRes };
}

function updateLog(msg, color='#8b949e') {
    const el = document.getElementById('log');
    el.innerText = msg;
    el.style.color = color;
}

function tick() {
    // Crowd Logic (Background noise)
    const res = getResistances();
    let move = (Math.random() - 0.5) * 2; // -1 to 1

    // Если высокий Supply, рынок тяготеет вниз (Selling pressure)
    if(floatingSupply > 0.5) move -= 0.5;
    
    // Если активирована ловушка (FOMO), толпа покупает
    if(crowdFOMO > 0) {
        move += (crowdFOMO / 10); 
        crowdFOMO -= 2; // FOMO затухает
        if(crowdFOMO < 0) crowdFOMO = 0;
    }

    // Применяем движение к цене
    if (move > 0) price += move * (1000 / res.up); 
    else price += move * (1000 / res.down);

    updateCandle();
    updateUI();
    
    // Авто-восстановление Supply (со временем люди снова покупают)
    if(Math.random() < 0.05 && floatingSupply < 0.9) {
        floatingSupply += 0.005;
    }
}

// --- PLAYER ACTIONS ---

function actionDump() {
    // SHAKEOUT: Продаем свои BTC, чтобы обвалить цену и напугать толпу
    const amountBTC = 5; 
    if(balanceBTC < amountBTC) { updateLog("Not enough BTC to dump!", "#da3633"); return; }
    
    const res = getResistances();
    // Эффективность дампа зависит от Supply. Если Supply много, дамп вызывает цепную реакцию.
    const impact = (amountBTC * price) / (res.down * 0.5); 
    
    balanceBTC -= amountBTC;
    balanceUSD += amountBTC * price;
    price -= impact;

    // KEY MECHANIC: Shakeout reduces floating supply
    // Чем сильнее падение, тем больше слабых рук выходят
    const panicFactor = 0.05 + (Math.random() * 0.05); 
    if(floatingSupply > 0.1) {
        floatingSupply -= panicFactor; 
        updateLog(`SHAKEOUT! Weak hands fleeing. Supply: -${(panicFactor*100).toFixed(1)}%`, "#da3633");
    } else {
        updateLog("Selling into empty void. No sellers left.", "#da3633");
    }
    
    updateCandle();
    updateUI();
}

function actionPump() {
    // PUMP: Покупаем за USDT
    const amountUSD = 10000;
    if(balanceUSD < amountUSD) { updateLog("Out of Cash!", "#da3633"); return; }

    const res = getResistances();
    const impact = amountUSD / res.up;

    balanceUSD -= amountUSD;
    balanceBTC += amountUSD / price;
    price += impact;

    // Feedback
    if(floatingSupply > 0.6) {
        updateLog("Pumping against Resistance! Costly!", "#d29922");
    } else {
        updateLog("PUMP IT! Price flying on low liquidity.", "#3fb950");
    }

    updateCandle();
    updateUI();
}

function actionTrap() {
    // BULL TRAP: Резкий рывок вверх, чтобы создать FOMO
    // Тратим деньги, но не получаем BTC (условно сжигаем на комиссии/маркетмейкинг ради графика)
    const cost = 5000;
    if(balanceUSD < cost) { updateLog("Need cash for trap!", "#da3633"); return; }
    
    balanceUSD -= cost;
    
    // Искусственный спайк цены
    price += price * 0.02; 
    
    // Trigger FOMO
    crowdFOMO = 100; 
    isTrapActive = true;
    
    updateLog("BULL TRAP ACTIVATED! Retail is buying! DUMP NOW!", "#d29922");
    setTimeout(() => { isTrapActive = false; }, 3000);
    
    updateCandle();
    updateUI();
}

// --- ENGINE ---

function updateCandle() {
    // New minute handling
    const now = Math.floor(Date.now()/1000);
    /* Для плавности симуляции мы обновляем текущую свечу, 
       но не создаем новую каждую секунду, а раз в N секунд или просто обновляем текущую
       в рамках демо упростим до "вечной свечи", которая сдвигается раз в 5 сек
    */
   
    // High/Low logic
    if(price > currentBar.high) currentBar.high = price;
    if(price < currentBar.low) currentBar.low = price;
    currentBar.close = price;
    
    // Reset bar occasionally for visual flow
    if (now - currentBar.time > 5) {
         currentBar = { time: now, open: price, high: price, low: price, close: price };
    }
    
    candleSeries.update(currentBar);
}

function updateUI() {
    document.getElementById('ui-usd').innerText = '$' + Math.floor(balanceUSD).toLocaleString();
    document.getElementById('ui-btc').innerText = balanceBTC.toFixed(2);
    document.getElementById('ui-supply').innerText = Math.floor(floatingSupply * 100) + '%';
    
    // Supply Bar Visual
    const bar = document.getElementById('supply-bar');
    bar.style.width = (floatingSupply * 100) + '%';
    
    if(floatingSupply > 0.6) bar.style.background = '#da3633'; // High danger
    else if(floatingSupply > 0.3) bar.style.background = '#d29922'; // Med
    else bar.style.background = '#3fb950'; // Low (Good for pump)

    // Phase Text
    const phaseEl = document.getElementById('phase-display');
    if(floatingSupply > 0.5) phaseEl.innerText = "1. SHAKEOUT NEEDED";
    else if(crowdFOMO > 50) phaseEl.innerText = "3. DISTRIBUTE NOW!";
    else phaseEl.innerText = "2. READY TO PUMP";
}

setInterval(tick, 200);

</script>
</body>
</html>
