<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Market Maker: The Struggle</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    body { margin: 0; background: #0b0e11; color: #c9d1d9; font-family: 'Roboto Mono', monospace; overflow-y: auto; -webkit-tap-highlight-color: transparent; }
    .wrapper { max-width: 600px; margin: 0 auto; padding: 10px; }
    
    /* HUD */
    .header { text-align: center; margin-bottom: 15px; }
    h3 { margin: 5px 0; color: #f0f6fc; text-transform: uppercase; letter-spacing: 1px; }
    .status-text { font-size: 11px; color: #8b949e; height: 15px; font-weight: bold;}

    /* BARS */
    .bar-container { margin-bottom: 12px; }
    .bar-label-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; }
    .bar-bg { width: 100%; height: 10px; background: #21262d; border-radius: 4px; overflow: hidden; position: relative; }
    
    /* Supply Bar (Bad) */
    .fill-supply { height: 100%; background: #da3633; width: 50%; transition: width 0.5s ease-out; }
    /* FOMO Bar (Good) */
    .fill-fomo { height: 100%; background: #238636; width: 0%; transition: width 0.5s ease-out; box-shadow: 0 0 10px #238636; }

    .stats-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;
    }
    .stat-card {
        background: #161b22; padding: 10px; border: 1px solid #30363d; border-radius: 6px;
        display: flex; flex-direction: column; justify-content: space-between;
    }
    .stat-label { font-size: 10px; color: #8b949e; text-transform: uppercase; }
    .stat-val { font-size: 15px; font-weight: 700; color: #f0f6fc; }
    .usd { color: #3fb950; }
    
    .chart-box { border: 1px solid #30363d; background: #0d1117; height: 260px; margin-bottom: 15px; border-radius: 6px; overflow: hidden; }
    #chart { width: 100%; height: 100%; }

    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button {
        padding: 18px 5px; border: none; border-radius: 6px; font-weight: 700; font-family: inherit; font-size: 14px;
        cursor: pointer; color: #fff; transition: transform 0.1s;
        border-bottom: 4px solid rgba(0,0,0,0.2);
    }
    button:active { transform: translateY(2px); border-bottom: 1px solid rgba(0,0,0,0.2); }
    
    .btn-dump { background: #da3633; } 
    .btn-pump { background: #238636; } 
    .sub-btn { display: block; font-size: 10px; font-weight: 400; opacity: 0.8; margin-top: 2px;}

    #log { font-size: 10px; color: #8b949e; text-align: center; margin-top: 10px; height: 20px; }
    
    .mania-active { animation: pulse 1s infinite; border: 2px solid #fff; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(35, 134, 54, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(35, 134, 54, 0); } 100% { box-shadow: 0 0 0 0 rgba(35, 134, 54, 0); } }
</style>
</head>
<body>

<div class="wrapper">
    <div class="header">
        <h3>LIQUIDITY WARS</h3>
        <div class="status-text" id="status-text">MARKET QUIET</div>
    </div>

    <div class="bar-container">
        <div class="bar-label-row">
            <span class="stat-label">FLOATING SUPPLY (SELLERS)</span>
            <span class="stat-val" style="font-size:12px" id="val-supply">50%</span>
        </div>
        <div class="bar-bg">
            <div class="fill-supply" id="bar-supply"></div>
        </div>
    </div>

    <div class="bar-container">
        <div class="bar-label-row">
            <span class="stat-label">RETAIL FOMO (TARGET)</span>
            <span class="stat-val" style="font-size:12px" id="val-fomo">0%</span>
        </div>
        <div class="bar-bg">
            <div class="fill-fomo" id="bar-fomo"></div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">LIQUIDITY (USDT)</span>
            <span class="stat-val usd" id="ui-usd">$1,000,000</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">INVENTORY (BTC)</span>
            <span class="stat-val" id="ui-btc">50.00</span>
        </div>
    </div>

    <div class="chart-box"><div id="chart"></div></div>

    <div class="controls">
        <button class="btn-dump" onclick="actionDump()">
            DUMP (SHAKEOUT)
            <span class="sub-btn">Scare Sellers (-Supply)</span>
        </button>
        <button class="btn-pump" onclick="actionPump()">
            PUMP (MARK UP)
            <span class="sub-btn">Raise Price (+Supply)</span>
        </button>
    </div>
    <div id="log">...</div>
</div>

<script>
// --- CONFIGURATION ---
let balanceUSD = 1000000;
let balanceBTC = 50;
let price = 1000;
const START_PRICE = 1000;

// GAME STATE
let floatingSupply = 0.50; // 50% start
let fomoLevel = 0.0;       // 0 to 1.0
let isManiaMode = false;   // The Win State

// CHART
const chart = LightweightCharts.createChart(document.getElementById('chart'), {
    layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
    grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
    timeScale: { timeVisible: true, secondsVisible: true, rightOffset: 5 },
    rightPriceScale: { borderVisible: false },
});
const candleSeries = chart.addCandlestickSeries({
    upColor: '#238636', downColor: '#da3633', borderVisible: false, wickUpColor: '#238636', wickDownColor: '#da3633'
});

let currentBar = { time: Math.floor(Date.now()/1000), open: price, high: price, low: price, close: price };
candleSeries.update(currentBar);

// --- LOGIC ---

function updateLog(msg, color) {
    const el = document.getElementById('log');
    el.innerText = msg;
    if(color) el.style.color = color;
}

// THE CORE LOOP (1 Second Tick)
function tick() {
    const now = Math.floor(Date.now()/1000);
    
    // 1. MANIA MODE (Auto-Win logic)
    if(isManiaMode) {
        // Толпа покупает у тебя сама!
        const autoBuy = 2; // BTC
        if(balanceBTC >= autoBuy) {
            balanceBTC -= autoBuy;
            balanceUSD += autoBuy * price;
            // Цена растет сама по инерции
            price += price * 0.01;
            updateLog("MANIA MODE! RETAIL IS BUYING EVERYTHING!", "#238636");
        } else {
            isManiaMode = false;
            updateLog("Sold out! Mania ended.", "#8b949e");
        }
        fomoLevel -= 0.05; // Mania burns out
        if(fomoLevel <= 0) isManiaMode = false;
    } 
    else {
        // 2. NORMAL MARKET PHYSICS
        
        // PASSIVE SUPPLY REGEN (Sellers return if boring)
        if(floatingSupply < 0.8) {
            floatingSupply += 0.005; 
        }

        // FOMO CALCULATION
        // FOMO grows if: Price is High AND Supply is Low
        const priceGain = (price - START_PRICE) / START_PRICE; // e.g. 0.10 (10%)
        
        if (priceGain > 0.05 && floatingSupply < 0.3) {
            fomoLevel += 0.02;
            updateLog("FOMO building... Keep Supply low!", "#d29922");
        } else {
            // FOMO decays if Supply is high (Fear/Resistance)
            fomoLevel -= 0.01;
            if(fomoLevel > 0) updateLog("FOMO dying... Too many sellers!", "#8b949e");
        }

        // Trigger MANIA
        if(fomoLevel >= 1.0 && !isManiaMode) {
            isManiaMode = true;
            document.body.style.background = "#0f1e13"; // Green tint
        }
    }

    // Clamp values
    if(fomoLevel < 0) fomoLevel = 0;
    if(fomoLevel > 1) fomoLevel = 1;
    if(floatingSupply < 0) floatingSupply = 0;
    if(floatingSupply > 1) floatingSupply = 1;

    // Price drift (Noise)
    let drift = (Math.random() - 0.5) * 5;
    // High supply drags price down
    if(floatingSupply > 0.6) drift -= 2;
    price += drift;

    updateCandle(now);
    updateUI();
}

function actionDump() {
    // SHAKEOUT
    if(balanceBTC < 1) return;
    
    const amountBTC = 2;
    // Force down
    price -= price * 0.03; // -3% dump
    balanceBTC -= amountBTC;
    balanceUSD += amountBTC * price;

    // MECHANIC: Dump scares away sellers (Reduces Supply)
    const scareFactor = 0.15; // -15% supply
    floatingSupply -= scareFactor;
    
    // But Dump kills FOMO
    fomoLevel -= 0.1;

    updateLog("SHAKEOUT! Weak hands leave.", "#da3633");
    updateCandle(Math.floor(Date.now()/1000));
    updateUI();
}

function actionPump() {
    // PUMP
    if(balanceUSD < 10000) return;

    // Cost depends on Supply (Resistance)
    // If Supply is 80%, Pump is weak. If 10%, Pump is strong.
    const resistance = 1 + (floatingSupply * 5); // 1x to 6x resistance
    const power = (20000 / resistance); // Price impact
    
    balanceUSD -= 20000;
    balanceBTC += (20000 / price);
    price += power;

    // MECHANIC: Pump attracts Profit Takers (Increases Supply)
    // The higher the price, the more supply comes in
    floatingSupply += 0.08; 

    updateLog("PUMP! Profit takers entering (+Supply)", "#238636");
    updateCandle(Math.floor(Date.now()/1000));
    updateUI();
}


function updateCandle(now) {
    if(price > currentBar.high) currentBar.high = price;
    if(price < currentBar.low) currentBar.low = price;
    currentBar.close = price;
    
    // Slow candles (10s)
    if (now - currentBar.time > 10) {
         currentBar = { time: now, open: price, high: price, low: price, close: price };
    }
    candleSeries.update(currentBar);
}

function updateUI() {
    document.getElementById('ui-usd').innerText = '$' + Math.floor(balanceUSD).toLocaleString();
    document.getElementById('ui-btc').innerText = balanceBTC.toFixed(2);
    
    // Supply Bar
    const sPct = Math.floor(floatingSupply * 100);
    document.getElementById('val-supply').innerText = sPct + '%';
    document.getElementById('bar-supply').style.width = sPct + '%';
    
    // FOMO Bar
    const fPct = Math.floor(fomoLevel * 100);
    document.getElementById('val-fomo').innerText = fPct + '%';
    document.getElementById('bar-fomo').style.width = fPct + '%';
    
    // Status
    const status = document.getElementById('status-text');
    if(isManiaMode) {
        status.innerText = "!!! RETAIL MANIA !!!";
        status.style.color = "#3fb950";
        document.querySelector('.wrapper').classList.add('mania-active');
    } else {
        document.querySelector('.wrapper').classList.remove('mania-active');
        document.body.style.background = "#0b0e11";
        if(floatingSupply > 0.7) {
            status.innerText = "TOO MUCH SUPPLY. DUMP IT.";
            status.style.color = "#da3633";
        } else if (fomoLevel > 0.5) {
             status.innerText = "FOMO BUILDING...";
             status.style.color = "#d29922";
        } else {
            status.innerText = "ACCUMULATION PHASE";
            status.style.color = "#8b949e";
        }
    }
}

// Slow Loop (1 sec)
setInterval(tick, 1000);

</script>
</body>
</html>
